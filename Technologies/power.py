# 
# This script generates the value of energy generated by the technologies related to Poer
# 
# This values will be used in my_indicators.py in 'set up()'
#
# Consider that scenario will modify the value of the output 
#
# Naming for functions: get_tech_gen(scenario)
# tech : the name used in my_indicators function 'propagate_tech()'
# at last each function will have the input of scenario 0/1
# (e.g. get_solar_power_gen(latitude, longitude, cellSize, scenario) for propagate_solar_panel())
#  
#Change line:166, 179, 143

import requests
import json

# solar energy technology
def get_solar_power(latitude, longitude, cellSize, scenario): #before get_solar_power_gen(lat, lon, area)
	'''
	this function will be called directly from Terascope Tool; will call the pv_watts_get function to get necessary solar data.
	paramters:
		latitude : float : latitude of location to use, range -90 to 90
		longitude : float : longitude of location to use, range -180 to 180
		cellSize : float : area of covered by each cell in terascope tool (m^2)
			- only 50% of the area will be assumed for solar power system installation
		scenario : int [0, 1, 2] : Timeline, this will change the efficiency according to the predictions for the technology
			0 represents the present : 15% efficiency 
			1 represents +10 years : 30% efficiency
			2 represents +50 years : 95% efficiency 
	returns:
		dictionary including : "system_capacity_kW", "latitude", "longitude", "scenario",  
								"annual_generation_kWh", "monthly_generation_kWh"
	methods:
		lambda = power generated = (efficiency used in pv_watts) * (solar radition) * (some other factors)
		power generated w/increased efficiency = (lambda / (efficiency used in pv_watts)) * (increased efficiency) 
											   = (solar radition) * (some other factors) * (increased efficiency)
	'''

	def pv_watts_get(sys_cap, lat, lon, array_type, time_frame='monthly', mod_type=1, losses=14.08, tilt=20, azimuth=180):
		'''
		requests GET API call to PV watts 
		parameters:
			api_key : str : my_api_key
			sys_cap : float : name plate capacity (kW), range 0.05-500000
			lat : float : latitude of location to use, range -90 to 90
			lon : float : longitude of location to use, range -180 to 180
			array_type : int : array type (0, 1, 2, 3, 4)
				0 = fixed - open rack (ground)
				1 = fixed - roof mounted (household roof)
				2 = 1-Axis
				3 = 1-Axis Backtracking
				4 = 2-Axis
			time_frame : str : granularity of the output response, monthly or hourly
			module_type : int : module type 
				0 = standard, crystalline silicon, 15% nominal efficiency, glass 
				1 = premium, crystalline silicon, 19% nominal  efficiency, glass with anti-reflective coating
				2 = thin film, thin film, 10% glass
			losses : float : percent system losses, range -5 to 99 
			tilt : float : tilt angle (degrees), range 0 to 90
			azimuth : float : azimuth angle (degrees), <360
			address : string : required if latitude, lon are not specified
		returns json:
			ac_monthly : list : monthly AC system output (kWhac)
			poa_monthly : list : monthly plane of array irradiance values. (kWh/m2)
			dc_monthly : list : Monthly DC array output. (kWhdc)
			solrad_monthly : list : Monthly solar radiation values. (kWh/m2/day)
			ac_annual : float : Annual AC system output. (kWhac)
			solrad_annual : float : Annual solar radiation values. (kWh/m2/day)
			capacity_factor : float : The ratio of the system's predicted electrical output in 
				the first year of operation to the nameplate output, which is equivalent to the 
				quantity of energy the system would generate if it operated at its nameplate 
				capacity for every hour of the year. (AC-to-DC)
		API details: https://developer.nrel.gov/docs/solar/pvwatts/v6/#examples
		'''

		# url creation for API get request
		nrel_url = "https://developer.nrel.gov"
		pvwatts_url = "/api/pvwatts/v6.json?"
		my_api_key = 'HL6NnxupaYwtWc2K8oJfwYkrsoJGRvGAaz2sfdBz'

		params = {
			"api_key": my_api_key, "system_capacity": sys_cap, 
		    "module_type": mod_type, "losses": losses, "array_type": array_type, 
		    "tilt": tilt, "azimuth": azimuth, "lat": lat, "lon":lon
		}

		# create url string with all desginated parameters
		url = nrel_url + pvwatts_url
		for key, value in params.items(): 
			url += key + "=" + str(value) + '&'

		# remove last '&'
		url = url[:-1]
		print('URL :', url)

		headers = {
		    'content-type': "application/x-www-form-urlencoded",
		    'cache-control': "no-cache"
		}

		# GET request to url 
		response = requests.request("GET", url, headers=headers)

		return response.json()

	# panel type = 210 W/m^2
	# divide by 1000 to convert to kW
	sys_cap = cellSize*0.5*210/1000 

	# pv watts data of roof mounted system
	pv_watts_data = dict(pv_watts_get(sys_cap, float(latitude), float(longitude), array_type=1))
	if pv_watts_data['errors']:
		print('Errors', pv_watts_data['errors'])
	
	# effiency used in PV watts 
	mod_types = {0: 0.15, 1: 0.19, 2: 0.1}
	current_eff = mod_types[int(pv_watts_data["inputs"]["module_type"])]
	
	scenario_annual_pv_gen = 0
	scenario_monthly_pv_gen = []
	if scenario ==0:
		# 15% efficiency, generation (kWhac)
		print('works_3')
		scenario_annual_pv_gen = pv_watts_data["outputs"]["ac_annual"]
		scenario_monthly_pv_gen = pv_watts_data["outputs"]["ac_monthly"]

	elif scenario == 1:
		# 30% efficiency, 10+ yrs from today, generation (kWhac)
		future10_eff = 0.3
		scenario_annual_pv_gen = round((pv_watts_data["outputs"]["ac_annual"]/current_eff)*future10_eff,2)
		scenario_monthly_pv_gen = [round((i/current_eff)*future10_eff,2) for i in pv_watts_data["outputs"]["ac_monthly"]]

	elif scenario == 2:
		# 95% efficiency, 30+ yrs from today, generation (kWhac)
		future50_eff = 0.95
		scenario_annual_pv_gen = round((pv_watts_data["outputs"]["ac_annual"]/current_eff)*future50_eff,2)
		scenario_monthly_pv_gen = [round((i/current_eff)*future50_eff,2) for i in pv_watts_data["outputs"]["ac_monthly"]]

	# results = {
	# 	"system_capacity_kW":sys_cap, "latitude": latitude, "longitude": longitude, "scenario": scenario, 
	# 	"annual_generation_kWh": scenario_annual_pv_gen, "monthly_generation_kWh": scenario_monthly_pv_gen}
	results = 3300 #cell, 20m2. We put 6 panels with 550 kW/h of energy per year from each panel on your roof

	return results


# nuclear energy technology
def get_nuclear_energy(cellSize, scenario):
	'''
	this function will be called directly from Terascope Tool. it leverages MIT ANPEG research and Westinghouse product - eVinci micro nuclear reactor.
	links to more informagion:
		https://www.westinghousenuclear.com/Portals/0/new%20plants/evincitm/eVinci%20Micro%20Reactor%20NPJ%20M-A%202019.pdf?ver=2019-04-30-211410-367 
		https://www.westinghousenuclear.com/new-plants/evinci-micro-reactor
		https://anpeg.mit.edu/about
	paramters:
		cellSize : float : area of covered by each cell in terascope tool (m^2)
			- this technology is not dependant upon area, however requires a minimum space of 231.886 m^2 (eq. to 2496 ft^2 = 0.06 acre) -> round to 235 m^2
	returns:
		dictionary including : "max_system_capacity_kWh", "annual_generation_kWh", "monthly_generation_kWh"
			- one eVinci micro NR produces between 200 kWe and 500 MWe, meaning 200 kWh - 500,000 kWh
	'''

	if cellSize < 0: #original: # if cellSize < 235: #REVIEW THIS!
		return None

	else:
		min_system_capacity_kWh = 200
		max_system_capacity_kWh = 500000

		min_annual_generation_kWh = 200*24*365
		max_annual_generation_kWh = 500000*24*365

		min_monthly_generation_kWh = [200*24*30]*12
		max_monthly_generation_kWh = [500000*24*30]*12

		# results = {"min_system_capacity_kWh": min_system_capacity_kWh, "max_system_capacity_kWh": max_system_capacity_kWh, 
		# 	"min_annual_generation_kWh": min_annual_generation_kWh, "max_annual_generation_kWh": c, 
		# 	"min_monthly_generation_kWh": min_monthly_generation_kWh, "max_monthly_generation_kWh": max_monthly_generation_kWh}
	results = max_annual_generation_kWh

	return results


# EXAMPLES #
#########################################################################
## EXAMPLE GET_SOLAR_POWER
#########################################################################
# area = 187900 # this is area of Jalisco /1000; area of Jalisco = 187.9 million m^2
# lat = 20.65
# lon = -103.26

# pv_generation = get_solar_power(lat, lon, area, scenario=0)
# print(pv_generation)

###############################
# OUTPUT GET_SOLAR_POWER
###############################
# {'system_capacity_kW': 19729.5, 'lat': 20.65, 'lon': -103.26, 
# 	'scenario': 0, 'annual_generation_kWh': 35569416.0, 
# 	'monthly_generation_kWh': [2908829.0, 2885999.25, 3518535.25, 3312188.25, 3169752.75, 2696853.0, 2736674.5, 2892661.5, 2708767.5, 3031611.25, 2907324.5, 2800213.5]} 

#########################################################################
## EXAMPLE GET_NUCLEAR_ENERGY
#########################################################################
# nuc_energy = get_nuclear_energy(cellSize = 300)
# print(nuc_energy)

###############################
# OUTPUT GET_NUCLEAR_ENERGY
###############################
# {'min_system_capacity_kWh': 200, 'max_system_capacity_kWh': 500000, 
# 'min_annual_generation_kWh': 1752000, 'max_annual_generation_kWh': 4380000000, 
# 'min_monthly_generation_kWh': [144000, 144000, 144000, 144000, 144000, 144000, 144000, 144000, 144000, 144000, 144000, 144000], 
# 'max_monthly_generation_kWh': [360000000, 360000000, 360000000, 360000000, 360000000, 360000000, 360000000, 360000000, 360000000, 360000000, 360000000, 360000000]}
